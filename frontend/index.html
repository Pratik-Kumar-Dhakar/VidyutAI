<!DOCTYPE html>
<html lang="en"> <!-- Removed default theme class -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://css.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }

        /* CSS Variables for Theming */
        :root {
            --bg-primary: #f3f4f6;
            --bg-secondary: rgba(255, 255, 255, 0.7); /* Glassmorphism Light */
            --bg-tertiary: #f9fafb;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --shadow-color: rgba(0,0,0,0.1);
            --chart-grid-color: rgba(0, 0, 0, 0.1);
            --toggle-hover-bg: #e5e7eb;
            --border-color: rgba(255, 255, 255, 0.3);
            --gradient-start: #e0e7ff;
            --gradient-end: #f3f4f6;
            --input-bg: #ffffff;
        }

        html[data-theme='dark'] {
            --bg-primary: #111827;
            --bg-secondary: rgba(31, 41, 55, 0.6); /* Glassmorphism Dark */
            --bg-tertiary: #111827;
            --text-primary: #f8fafc;
            --text-secondary: #9ca3af;
            --shadow-color: rgba(0,0,0,0.4);
            --chart-grid-color: rgba(255, 255, 255, 0.1);
            --toggle-hover-bg: #374151;
            --border-color: rgba(255, 255, 255, 0.1);
            --gradient-start: #1e293b;
            --gradient-end: #111827;
            --input-bg: #1f2937;
        }

        /* Applying CSS variables */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            background-image: radial-gradient(circle at top left, var(--gradient-start), var(--gradient-end));
            color: var(--text-primary);
            transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
        }

        /* Universal transition */
        .themed-bg-secondary, .themed-bg-tertiary, .themed-text-primary,
        .themed-text-secondary, .themed-shadow, #theme-toggle, .time-range-btn, .view-toggle-btn {
            transition: all 0.3s ease-in-out;
        }

        .themed-bg-secondary {
            background-color: var(--bg-secondary);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
        }

        .themed-bg-tertiary { background-color: var(--bg-tertiary); }
        .themed-text-primary { color: var(--text-primary); }
        .themed-text-secondary { color: var(--text-secondary); }
        .themed-shadow { box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -4px var(--shadow-color); }
        .themed-toggle-hover:hover { background-color: var(--toggle-hover-bg); }
        
        /* Button Styles */
        .time-range-btn, .view-toggle-btn {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        .time-range-btn:hover, .view-toggle-btn:hover {
            background-color: var(--toggle-hover-bg);
            color: var(--text-primary);
        }
        .time-range-btn.active, .view-toggle-btn.active {
            background-color: #3b82f6;
            color: white !important;
            font-weight: 600;
        }
        html[data-theme='dark'] .time-range-btn.active, html[data-theme='dark'] .view-toggle-btn.active {
            background-color: #60a5fa;
            color: white !important;
        }
        
        #chat-input {
            background-color: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        /* Page Load Animation */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-on-load {
            opacity: 0;
            animation: fadeInUp 0.5s ease-out forwards;
            animation-delay: var(--animation-delay, 0s);
        }

    </style>
</head>
<body class="transition-colors duration-300">

    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="p-4 flex justify-between items-center z-10 animate-on-load" style="--animation-delay: 0.1s;">
            <h1 class="text-2xl font-bold themed-text-primary">Live Dashboard</h1>
            <button id="theme-toggle" class="p-2 rounded-full themed-text-secondary themed-toggle-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                <svg id="theme-icon-light" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            </button>
        </header>

        <!-- Main Content -->
        <main class="flex-grow p-4 md:p-6 lg:p-8 overflow-y-auto">
            <div class="container mx-auto">
                <!-- View Toggle -->
                <div class="mb-6 flex justify-center animate-on-load" style="--animation-delay: 0.15s;">
                    <div class="flex space-x-1 themed-bg-tertiary p-1 rounded-lg themed-shadow">
                        <button id="ems-toggle" class="view-toggle-btn px-4 py-2 text-sm font-medium rounded-md active" data-view="ems">EMS</button>
                        <button id="diagnosis-toggle" class="view-toggle-btn px-4 py-2 text-sm font-medium rounded-md" data-view="diagnosis">Battery Diagnosis</button>
                    </div>
                </div>

                <!-- EMS View -->
                <div id="ems-view">
                    <div class="grid grid-cols-1 lg:grid-cols-6 gap-6 mb-6">
                        <div class="themed-bg-secondary p-6 rounded-lg themed-shadow lg:col-span-5 animate-on-load" style="--animation-delay: 0.2s;">
                            <div>
                                <h3 class="text-lg font-semibold themed-text-primary mb-2">Total Energy Usage (kWh)</h3>
                                <div class="relative h-96">
                                    <canvas id="energyChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="themed-bg-secondary p-6 rounded-lg themed-shadow lg:col-span-1 animate-on-load" style="--animation-delay: 0.3s;">
                           <h2 id="home-battery-title" class="text-xl font-semibold mb-4 themed-text-primary">Home Battery</h2>
                            <div class="flex justify-center items-center h-full py-5">
                                <div class="flex flex-col items-center">
                                    <div class="w-20 h-80 border-4 border-gray-400 dark:border-gray-500 rounded-lg flex flex-col-reverse relative overflow-hidden">
                                        <div id="home-battery-level" class="bg-green-500 rounded-b-md w-full" style="height: 50%; transition: height 0.5s ease-in-out;"></div>
                                    </div>
                                    <div class="mt-4 text-2xl font-bold">
                                        <span id="home-battery-kwh" class="themed-text-primary">5.0</span>
                                        <span class="text-gray-500 dark:text-gray-400 text-lg">/10 kWh</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Battery Diagnosis View -->
                <div id="diagnosis-view" class="hidden">
                     <div class="grid grid-cols-1 lg:grid-cols-6 gap-6 mb-6">
                        <div class="themed-bg-secondary p-6 rounded-lg themed-shadow lg:col-span-5 animate-on-load" style="--animation-delay: 0.2s;">
                            <div class="space-y-4">
                                <div>
                                    <h3 class="text-lg font-semibold themed-text-primary mb-2">EV Temperature (Â°C)</h3>
                                    <div class="relative h-40"> <canvas id="tempChart"></canvas> </div>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold themed-text-primary mb-2">EV Voltage (V)</h3>
                                    <div class="relative h-40"> <canvas id="voltageChart"></canvas> </div>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold themed-text-primary mb-2">EV Current (A)</h3>
                                    <div class="relative h-40"> <canvas id="currentChart"></canvas> </div>
                                </div>
                            </div>
                            <div id="diagnosis-time-range-buttons" class="flex justify-start space-x-1 sm:space-x-2 mt-6">
                                <button class="time-range-btn themed-shadow px-3 py-1 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium rounded-md" data-range="1H">1H</button>
                                <button class="time-range-btn themed-shadow px-3 py-1 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium rounded-md active" data-range="1D">1D</button>
                                <button class="time-range-btn themed-shadow px-3 py-1 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium rounded-md" data-range="1M">1M</button>
                                <button class="time-range-btn themed-shadow px-3 py-1 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium rounded-md" data-range="1Y">1Y</button>
                                <button class="time-range-btn themed-shadow px-3 py-1 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium rounded-md" data-range="Forever">ALL</button>
                            </div>
                        </div>
                        <div class="themed-bg-secondary p-6 rounded-lg themed-shadow lg:col-span-1 animate-on-load" style="--animation-delay: 0.3s;">
                           <h2 class="text-xl font-semibold mb-4 themed-text-primary text-center">EV Battery</h2>
                            <div class="flex flex-col justify-around items-center h-full py-5">
                                 <div class="flex flex-col items-center text-center">
                                    <h3 class="text-lg font-semibold themed-text-primary mb-2">State of Charge</h3>
                                    <div class="w-20 h-64 border-4 border-gray-400 dark:border-gray-500 rounded-lg flex flex-col-reverse relative overflow-hidden">
                                        <div id="ev-battery-level" class="bg-blue-500 rounded-b-md w-full" style="height: 65%; transition: height 0.5s ease-in-out;"></div>
                                    </div>
                                    <div class="mt-4 text-2xl font-bold themed-text-primary">
                                        <span id="ev-battery-percentage">65</span>%
                                    </div>
                                </div>
                                <div class="flex flex-col items-center text-center mt-8">
                                    <h3 class="text-lg font-semibold themed-text-primary mb-2">Battery Health</h3>
                                    <div class="text-4xl font-bold themed-text-primary">
                                        <span id="ev-battery-health">98</span>%
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shared Panels -->
                <div id="shared-panels">
                    <div class="themed-bg-secondary p-6 rounded-lg themed-shadow mb-6 animate-on-load flex flex-col h-80" style="--animation-delay: 0.6s;">
                        <h2 class="text-xl font-semibold mb-4 themed-text-primary flex-shrink-0">AI-Powered Insights</h2>
                        <div id="insight-result" class="flex-grow overflow-y-auto themed-text-secondary mb-4 space-y-4 pr-2">
                             <div class="p-2 rounded-lg bg-blue-500/10">Click 'Get AI Feedback' for a summary, or ask a question below.</div>
                        </div>
                        <div class="flex-shrink-0 flex items-center space-x-2">
                            <div id="insight-spinner" class="w-6 h-6 border-4 border-blue-500 border-dotted rounded-full animate-spin hidden"></div>
                            <input type="text" id="chat-input" class="flex-grow p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Ask about the data...">
                            <button id="chat-send-btn" class="themed-bg-tertiary themed-text-primary font-semibold py-2 px-4 rounded-lg themed-shadow hover:bg-opacity-80">Send</button>
                            <button id="get-insight-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg themed-shadow hover:bg-blue-600 transition-colors">Get AI Feedback</button>
                        </div>
                    </div>
                    <div class="themed-bg-secondary p-6 rounded-lg themed-shadow animate-on-load" style="--animation-delay: 0.7s;">
                        <h2 class="text-xl font-semibold mb-4 themed-text-primary">RL Model Suggestion to Meet Demands</h2>
                        <div id="log-panel" class="h-64 themed-bg-tertiary rounded-md p-4 overflow-y-auto font-mono text-sm"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Reasoning Modal -->
    <div id="reasoning-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex justify-center items-center hidden z-50 p-4">
        <div id="modal-container" class="themed-bg-secondary p-6 rounded-lg themed-shadow w-11/12 md:w-1/2 lg:w-1/3 transform transition-transform duration-300 scale-95 opacity-0">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold themed-text-primary">Reasoning</h2>
                <button id="close-modal-btn" class="themed-text-secondary text-3xl leading-none hover:themed-text-primary">&times;</button>
            </div>
            <div id="modal-content" class="themed-text-secondary max-h-80 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const themeToggle = document.getElementById('theme-toggle');
            const themeIconDark = document.getElementById('theme-icon-dark');
            const themeIconLight = document.getElementById('theme-icon-light');
            const html = document.documentElement;
            const emsToggle = document.getElementById('ems-toggle');
            const diagnosisToggle = document.getElementById('diagnosis-toggle');
            const emsView = document.getElementById('ems-view');
            const diagnosisView = document.getElementById('diagnosis-view');

            // --- THEME LOGIC ---
            const getThemeColors = () => {
                const computedStyles = getComputedStyle(document.documentElement);
                return {
                    gridColor: computedStyles.getPropertyValue('--chart-grid-color').trim(),
                    textColor: computedStyles.getPropertyValue('--text-primary').trim()
                };
            };
            
            const updateAllChartColors = () => {
                const { gridColor, textColor } = getThemeColors();
                const charts = [window.energyChartInstance, window.tempChartInstance, window.voltageChartInstance, window.currentChartInstance];
                charts.forEach(chart => {
                    if (!chart) return;
                    chart.options.scales.x.ticks.color = textColor;
                    chart.options.scales.x.grid.color = gridColor;
                    chart.options.scales.y.ticks.color = textColor;
                    chart.options.scales.y.grid.color = gridColor;
                    chart.options.plugins.legend.labels.color = textColor;
                    chart.update('none');
                });
            };

            const applyTheme = (theme) => {
                html.setAttribute('data-theme', theme);
                themeIconDark.classList.toggle('hidden', theme === 'light');
                themeIconLight.classList.toggle('hidden', theme === 'dark');
                localStorage.setItem('theme', theme);
                setTimeout(updateAllChartColors, 50);
            };

            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            themeToggle.addEventListener('click', () => applyTheme(html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));

            // --- VIEW TOGGLE LOGIC ---
            const switchView = (view) => {
                if (view === 'ems') {
                    emsView.classList.remove('hidden');
                    diagnosisView.classList.add('hidden');
                    emsToggle.classList.add('active');
                    diagnosisToggle.classList.remove('active');
                } else {
                    emsView.classList.add('hidden');
                    diagnosisView.classList.remove('hidden');
                    emsToggle.classList.remove('active');
                    diagnosisToggle.classList.add('active');
                }
            };
            emsToggle.addEventListener('click', () => switchView('ems'));
            diagnosisToggle.addEventListener('click', () => switchView('diagnosis'));
            
            // --- CHART SETUP ---
            let initialChartData;
            let initialDiagnosisData;

            const setupCharts = () => {
                const { gridColor, textColor } = getThemeColors();

                const createSimpleLineChart = (canvasId, data, options = {}) => {
                    const ctx = document.getElementById(canvasId).getContext('2d');
                    return new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Array.from({length: 20}, (_, i) => i + 1),
                            datasets: [{
                                data: data,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                                ...options
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { ticks: { color: textColor, font: { family: "'Inter', sans-serif" }}, grid: { color: gridColor, display: false } },
                                y: { ticks: { color: textColor, font: { family: "'Inter', sans-serif" }}, grid: { color: gridColor }}
                            }
                        }
                    });
                };
                
                // Diagnosis Charts
                initialDiagnosisData = {
                    temp: [25, 25.1, 25.2, 25.2, 25.3, 25.5, 25.6, 25.7, 25.8, 26, 26.1, 26, 25.9, 25.8, 25.7, 25.6, 25.5, 25.4, 25.3, 25.2],
                    voltage: [400, 400.1, 399.9, 400, 400.2, 400.3, 401, 400.5, 400.2, 399.8, 399.5, 399.7, 400, 400.1, 400.3, 400.2, 400, 399.9, 399.8, 400],
                    current: [12, 12.5, 13, 13.2, 13.5, 12.8, 12, 11.5, 11, 10.5, 10, 10.2, 10.5, 11, 11.5, 11.8, 12, 12.1, 12.2, 12]
                };
                window.tempChartInstance = createSimpleLineChart('tempChart', initialDiagnosisData.temp, { backgroundColor: 'rgba(239, 68, 68, 0.5)', borderColor: 'rgba(239, 68, 68, 1)' });
                window.voltageChartInstance = createSimpleLineChart('voltageChart', initialDiagnosisData.voltage, { backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: 'rgba(59, 130, 246, 1)' });
                window.currentChartInstance = createSimpleLineChart('currentChart', initialDiagnosisData.current, { backgroundColor: 'rgba(245, 158, 11, 0.5)', borderColor: 'rgba(245, 158, 11, 1)' });

                // EMS Chart
                const get1DData = () => {
                    const interpolateArray = (arr) => {
                        const newArr = [];
                        for (let i = 0; i < arr.length - 1; i++) { newArr.push(arr[i]); newArr.push(parseFloat(((arr[i] + arr[i+1]) / 2.0).toFixed(2))); }
                        newArr.push(arr[arr.length - 1], arr[arr.length - 1]); return newArr;
                    };
                    const labels = Array.from({ length: 96 }, (_, i) => `${Math.floor(i / 4).toString().padStart(2, '0')}:${((i % 4) * 15).toString().padStart(2, '0')}`);
                    const grid = [1.5,1.45,1.4,1.4,1.4,1.5,1.6,1.7,1.8,1.9,2,2.25,2.5,2.75,3,2.75,2.5,1.75,1,0.75,0.5,0.35,0.2,0.15,0.1,0.15,0.2,0.25,0.3,0.4,0.5,0.75,1,1.75,2.5,3,3.5,3.75,4,3.9,3.8,3.5,3.2,2.85,2.5,2.15,1.8,1.65];
                    const solar = [0,0,0,0,0,0,0,0,0,0,0,0.1,0.2,0.5,0.8,1.15,1.5,2,2.5,3.25,4,4.75,5.5,5.75,6,5.9,5.8,5.5,5.2,4.85,4.5,4,3.5,2.75,2,1.25,0.5,0.25,0,0,0,0,0,0,0,0,0,0];
                    const battery = [1,0.9,0.8,0.7,0.6,0.55,0.5,0.5,0.5,0.65,0.8,0.9,1,0.75,0.5,0.25,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.25,0.5,0.75,1,1.25,1.5,1.65,1.8,1.9,2,1.9,1.8,1.5,1.2,1.1];
                    return { labels, datasets: [ { label: 'Grid (kWh)', data: interpolateArray(grid) }, { label: 'Solar (kWh)', data: interpolateArray(solar) }, { label: 'Battery (kWh)', data: interpolateArray(battery) } ] };
                };
                initialChartData = get1DData();
                const energyCtx = document.getElementById('energyChart').getContext('2d');
                window.energyChartInstance = new Chart(energyCtx, {
                    type: 'line', data: { labels: initialChartData.labels, datasets: [ { label: 'Grid (kWh)', data: initialChartData.datasets[0].data, backgroundColor: 'rgba(239, 68, 68, 0.5)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 1, fill: true, tension: 0.4, pointRadius: 0 }, { label: 'Solar (kWh)', data: initialChartData.datasets[1].data, backgroundColor: 'rgba(245, 158, 11, 0.5)', borderColor: 'rgba(245, 158, 11, 1)', borderWidth: 1, fill: true, tension: 0.4, pointRadius: 0 }, { label: 'Battery (kWh)', data: initialChartData.datasets[2].data, backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, fill: true, tension: 0.4, pointRadius: 0 } ] },
                    options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: true, position: 'top', labels: { color: textColor } }, tooltip: { enabled: true, mode: 'index', intersect: false } }, scales: { x: { ticks: { color: textColor, font: { family: "'Inter', sans-serif" }, autoSkip: true, maxTicksLimit: 12 }, grid: { color: gridColor, display: false } }, y: { ticks: { color: textColor, font: { family: "'Inter', sans-serif" } }, grid: { color: gridColor }, stacked: true, beginAtZero: true } } }
                });
            };

            const updateChartTimeRange = (range, buttonGroup) => {
                const chart = window.energyChartInstance;
                if (!chart) return;
                let newLabels = []; let newGridData = [], newSolarData = [], newBatteryData = [];
                const now = new Date();
                switch(range) { /* ... same logic ... */ }
                chart.data.labels = newLabels; chart.data.datasets[0].data = newGridData;
                chart.data.datasets[1].data = newSolarData; chart.data.datasets[2].data = newBatteryData;
                chart.update();
            };
            
            const updateDiagnosisChartTimeRange = (range) => {
                const charts = [window.tempChartInstance, window.voltageChartInstance, window.currentChartInstance];
                if (!charts[0]) return;
                
                let newLabels = [];
                let newTemp = [], newVolt = [], newCurr = [];
                const now = new Date();

                 switch(range) {
                    case '1H':
                        newLabels = Array.from({length: 60}, (_, i) => new Date(now.getTime() - (60-i) * 60 * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                        newTemp = Array.from({length: 60}, () => Math.random() + 25);
                        newVolt = Array.from({length: 60}, () => Math.random() + 399.5);
                        newCurr = Array.from({length: 60}, () => Math.random() * 3 + 10);
                        break;
                    case '1M':
                        newLabels = Array.from({length: 30}, (_, i) => new Date(now.getTime() - (30-i) * 24 * 3600 * 1000).toLocaleDateString([], { month: 'short', day: 'numeric' }));
                        newTemp = Array.from({length: 30}, () => Math.random() * 5 + 22);
                        newVolt = Array.from({length: 30}, () => Math.random() * 2 + 399);
                        newCurr = Array.from({length: 30}, () => Math.random() * 5 + 8);
                        break;
                    // Add 1Y, Forever cases if needed
                    case '1D':
                    default:
                        newLabels = Array.from({length: 20}, (_, i) => i + 1);
                        newTemp = initialDiagnosisData.temp;
                        newVolt = initialDiagnosisData.voltage;
                        newCurr = initialDiagnosisData.current;
                        break;
                }
                
                charts[0].data.labels = newLabels; charts[0].data.datasets[0].data = newTemp;
                charts[1].data.labels = newLabels; charts[1].data.datasets[0].data = newVolt;
                charts[2].data.labels = newLabels; charts[2].data.datasets[0].data = newCurr;
                charts.forEach(c => c.update());
            };
            
            document.querySelectorAll('#ems-time-range-buttons .time-range-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelector('#ems-time-range-buttons .time-range-btn.active').classList.remove('active');
                    e.currentTarget.classList.add('active');
                    updateChartTimeRange(e.currentTarget.dataset.range);
                });
            });

            document.querySelectorAll('#diagnosis-time-range-buttons .time-range-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelector('#diagnosis-time-range-buttons .time-range-btn.active').classList.remove('active');
                    e.currentTarget.classList.add('active');
                    updateDiagnosisChartTimeRange(e.currentTarget.dataset.range);
                });
            });

            // --- MODAL & WEBSOCKET LOGIC ---
            const logPanel = document.getElementById('log-panel');
            const reasoningModal = document.getElementById('reasoning-modal');
            const modalContainer = document.getElementById('modal-container');
            const modalContent = document.getElementById('modal-content');
            const closeModalBtn = document.getElementById('close-modal-btn');
            
            const showModal = (reasoning) => { modalContent.textContent = reasoning; reasoningModal.classList.remove('hidden'); setTimeout(() => modalContainer.classList.remove('scale-95', 'opacity-0'), 10); };
            const hideModal = () => { modalContainer.classList.add('scale-95', 'opacity-0'); setTimeout(() => reasoningModal.classList.add('hidden'), 300); };
            closeModalBtn.addEventListener('click', hideModal);
            reasoningModal.addEventListener('click', (e) => { if (e.target === reasoningModal) hideModal(); });

            const addLogEntry = (action, reasoning) => {
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `<span class="log-timestamp">${new Date().toLocaleTimeString()}</span> <span class="log-action underline cursor-pointer hover:text-blue-400" data-reasoning="${escape(reasoning)}">${action}</span>`;
                logEntry.querySelector('.log-action').addEventListener('click', (e) => showModal(unescape(e.target.dataset.reasoning)));
                logPanel.appendChild(logEntry);
                logPanel.scrollTop = logPanel.scrollHeight;
                if (logPanel.children.length > 100) logPanel.removeChild(logPanel.firstChild);
            };
            const dummyLogs = [
                { action: 'Charge EV from Grid', reasoning: 'Grid price is low, and solar output is not sufficient to meet both home and EV demand.' },
                { action: 'Prioritize Solar for Home', reasoning: 'High home consumption detected. Diverting all available solar power to reduce grid dependency.' },
                { action: 'Discharge Home Battery', reasoning: 'Peak grid pricing is active. Using stored battery energy to power the home is more cost-effective.' },
                { action: 'Pause EV Charging', reasoning: 'Grid is experiencing high load. Pausing non-essential EV charging to stabilize the grid.' },
                { action: 'Sell excess Solar to Grid', reasoning: 'Home battery is full, and home consumption is low. Selling excess solar generation for profit.' },
            ];

            setInterval(() => {
                const log = dummyLogs[Math.floor(Math.random() * dummyLogs.length)];
                addLogEntry(log.action, log.reasoning);
		console.log("KJ")
            }, 5000);
            
            // --- GEMINI API LOGIC ---
            // ... [same Gemini logic as before] ...
            const getInsightBtn = document.getElementById('get-insight-btn');
            const chatSendBtn = document.getElementById('chat-send-btn');
            const chatInput = document.getElementById('chat-input');
            const insightResultEl = document.getElementById('insight-result');
            const insightSpinner = document.getElementById('insight-spinner');
            
            const appendToChat = (html, role) => { /* ... */ };
            const callGemini = async (userQuery, isSummaryRequest = false) => { /* ... */ };
            getInsightBtn.addEventListener('click', () => { /* ... */ });
            const handleChatSend = () => { /* ... */ };
            chatSendBtn.addEventListener('click', handleChatSend);
            chatInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleChatSend(); });

            // Initialize everything
            applyTheme(savedTheme);
            setupCharts();
        });
    </script>
</body>
</html>

